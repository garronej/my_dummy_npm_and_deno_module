
# my-dummy-npm-and-deno-module

A demo project that serve as a tutorial on how to setup denoify.

NOTE: For a new module name favor '_' over '-' in the module name as it is
a deno requirement not to use '_'

## Step 1: Provide port for dependencies the module is using.

This demo project depends on tree modules:
  - ``"js-yaml"``: A port exists for deno, add a field you ``package.json`` to tell denoify to use it:

```json
"dependencies": {
    "js-yaml": "^3.13.1"
},
"denoPorts": {
    "js-yaml": "https://deno.land/x/js_yaml_port@3.13.1/js-yaml.js"
},
```
  - ``"run-exclusive"``: There is noting to be done, this package has been made cross compatible by denoify.

  - ``"ts-md5"``: We need to fork the repo and denoify it ourselvs as it has been done [here](https://github.com/garronej/ts-md5). Then we have to update our ``package.json``:  
  ```json
  //If previously we had: 
  "dependencies": {
        "ts-md5": "^1.2.7"
  }
  ```
  ```json
  //We must replace it by:
  "dependencies": {
        "ts-md5": "garronej/ts-md5#v1.2.7"
  }
  ```

We can ignore the dev dependencies as they are not mandatory to run the module.

## Step 2: Edit tsconfig.json 

### Make sure you use the "outDir" option.

Denoify reads the "outDir" field of the ``tsconfig.json`` filed to determine where to put the de generated source so it must be completed.
The typical value to use is: 
```json
{
    "compilerOptions": {
        "outDir": "./dist"
    }
}
```

### Enable strict mode and fixes errors if any.

By default deno as all strict modes enable so if you want your module to run on deno regardless of the context you must set: 

```json
{
    "compilerOptions": {
        "noUnusedLocals": true, 
        "noUnusedParameters": true, 
        "strict": true 
    }
}
```

It might rise a lot of error but they are all very easy to fix even if you are not familiar with the codebase. 

For errors related to ``this`` or that implicitly having an any type, replace:
```typescript
function myFun(a): number{
    this.doSomething(a);
}
```
by:
```typescript
function myFun(this: any, a: any): number{
    this.doSomething(a);
}
```
If you don't know any better.  

For errors relating to something that can be null or undefined, replace:
```typescript
x.doSomething();
```
by:
```typescript
x!.doSomething();
```

For error related to uninitialized property, replace:
```typescript
class Foo {
    n: number;
}
```
by:
```typescript
class Foo {
    n!: number;
}
```

For errors relative to name that cannot be found: 

```typescript
describe(...)
```
```typescript
declare const describe: any;
describe(...)
```

For unused variables:

```typescript
const x=3;
```
```typescript
const x=3; x;
```

### Explicitly excludes the deno files from compilation

``tsconfig.json``
```json
{

    "exclude": [
        "node_modules",
        "dist",
        "./deno_dist",
        "./mod.ts"
    ]
}
```

## Edit your ``npm`` scripts

First off, run ``> npm install --save-dev garronej/denoify`` then add/edit
the ``npm`` scripts.

``package.json``
```json
    "devDependencies": {
        "denoify": "garronej/denoify",
    }
    "scripts": {
        "tsc": "npx tsc",
        "denoify": "npx denoify",
        "build": "npm run tsc && npm run denoify",
    }
```

No every time you will run ``> npm run build`` the sources for deno ( ``./deno_dist`` and ``./mod.ts`` ) will be updated.

The files generated by denoify should be committed.

## Create a new GitHub release every time you publish on npm.

Just after running ``> npm publish`` got to your GitHub repo pages -> release -> create new release ( or draft ne release ) and tag version enter ``v0.1.0`` matching the current version in your ``package.json`` file.

## (Optional) Publish your module on deno.land

If you want your module to be listed here: https://deno.land/x/
Edit this file: https://github.com/denoland/deno_website2/blob/master/src/database.json
insert (at the right position, alphabetical ordering):
```json
"my_dummy_npm_and_deno_module": {
    "type": "github",
    "owner": "garronej",
    "repo": "my_dummy_npm_and_deno_module",
    "desc": "Demo how to make cross compatible module with denoify"
  },
```

# Conclusion

It is now possible to use your module on node using ( assuming you have published it with ``npm publish`` ):

``> npm install --save my-dummy-npm-and-deno-module``
then: 
```typescript
import { Cat } from "my-dummy-npm-and-deno-module"
```

And on deno with:

```typescript
import { Cat } from "https://deno.land/x/my_dummy_npm_and_deno_module@v0.1.0/mod.ts";
```
or if you haven't published on Deno.land:

```typescript
import { Cat } from "https://raw.githubusercontent.com/garronej/my_dummy_npm_and_deno_module/v0.1.0/mod.ts";
```

On top of that this module can now be used as a dependency in other modules that uses ``denoify``